# 宝塔面板配置指南

## 问题诊断

你的应用无法通过域名访问，主要原因是：

1. **应用只监听localhost** - 已修复
2. **宝塔面板反向代理配置问题**
3. **防火墙设置问题**

## 宝塔面板配置步骤

### 1. 检查应用是否正常运行

在服务器上执行：
```bash
# 检查PM2状态
pm2 status

# 检查端口监听
netstat -tlnp | grep :3000

# 测试本地访问
curl http://localhost:3000/api/health
```

### 2. 配置网站

1. 登录宝塔面板
2. 点击"网站" → "添加站点"
3. 填写域名（如：api.yourdomain.com）
4. 选择PHP版本为"纯静态"
5. 创建完成后，点击"设置"

### 3. 配置反向代理

1. 在网站设置中，点击"反向代理"
2. 点击"添加反向代理"
3. 配置如下：
   - **代理名称**: blog-api
   - **目标URL**: http://127.0.0.1:3000
   - **发送域名**: $host
   - **缓存**: 关闭

### 4. 配置SSL证书（可选）

1. 在网站设置中，点击"SSL"
2. 选择"Let's Encrypt"免费证书
3. 勾选"强制HTTPS"

### 5. 配置伪静态（如果需要）

在网站设置中，点击"伪静态"，添加：
```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 6. 检查防火墙

1. 在宝塔面板中，点击"安全"
2. 确保端口80和443已开放
3. 如果使用其他端口，也需要开放

### 7. 测试访问

配置完成后，测试：
```bash
# 测试域名访问
curl http://yourdomain.com/api/health

# 检查反向代理日志
tail -f /www/wwwlogs/yourdomain.com.log
```

## 常见问题解决

### 问题1: 502 Bad Gateway
**原因**: 后端服务未启动或端口错误
**解决**: 
```bash
# 重启PM2服务
pm2 restart blog-backend

# 检查端口
netstat -tlnp | grep :3000
```

### 问题2: 403 Forbidden
**原因**: 权限问题或CORS配置
**解决**: 检查.env文件中的CORS_ORIGIN配置

### 问题3: 连接超时
**原因**: 防火墙阻止或应用未监听外部地址
**解决**: 
```bash
# 检查应用监听地址
ss -tlnp | grep :3000

# 应该显示: 0.0.0.0:3000
```

## 调试命令

```bash
# 查看PM2日志
pm2 logs blog-backend

# 查看Nginx错误日志
tail -f /www/wwwlogs/nginx_error.log

# 查看网站访问日志
tail -f /www/wwwlogs/yourdomain.com.log

# 测试端口连通性
telnet yourdomain.com 80
```

## 环境变量检查

确保.env文件包含正确的CORS配置：
```env
CORS_ORIGIN=https://yourdomain.com,http://yourdomain.com
```

## 完成配置后

1. 重启PM2服务：`pm2 restart blog-backend`
2. 重启Nginx：`nginx -s reload`
3. 测试域名访问：`curl https://yourdomain.com/api/health`

如果仍有问题，请检查宝塔面板的错误日志和PM2日志。
