name: Deploy BlogBackend

on:
  push:
    branches:
      - main  # 你实际用的分支

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # 你的Node版本

      - name: Install dependencies
        run: npm install

      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: ${{ secrets.TARGET_DIR }}
          strip_components: 0

      - name: Setup environment file
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.TARGET_DIR }}
            
            # 删除旧的.env文件（避免与PM2环境变量冲突）
            rm -f .env
            
            echo "已删除.env文件，将使用PM2环境变量"
            
            echo "环境文件创建完成"

      - name: Install production dependencies
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.TARGET_DIR }}
            echo "开始安装生产依赖..."
            npm install --production
            echo "依赖安装完成"

      - name: Update PM2 ecosystem config
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.TARGET_DIR }}
            echo "更新PM2配置文件..."
            
            # 备份原配置文件
            cp ecosystem.config.js ecosystem.config.js.backup
            
            # 使用环境变量更新配置文件
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'blog-backend',
                script: './bin/www',
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                // 开发环境配置
                env: {
                  NODE_ENV: 'development',
                  PORT: 3000
                },
                // 生产环境配置
                env_production: {
                  NODE_ENV: 'production',
                  DB_DIALECT: 'mysql',
                  DB_HOST: '${{ secrets.DB_HOST }}',
                  DB_PORT: 3306,
                  DB_NAME: '${{ secrets.DB_NAME }}',
                  DB_USER: '${{ secrets.DB_USER }}',
                  DB_PASSWORD: '${{ secrets.DB_PASSWORD }}',
                  PORT: 3000,
                  JWT_SECRET: '${{ secrets.JWT_SECRET }}',
                  JWT_EXPIRES_IN: '1d',
                  CORS_ORIGIN: '${{ secrets.CORS_ORIGIN }}'
                },
                // 日志配置
                log_file: './logs/combined.log',
                out_file: './logs/out.log',
                error_file: './logs/error.log',
                log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
                // 进程管理
                min_uptime: '5s',
                max_restarts: 5,
                // 监听配置
                listen_timeout: 5000,
                kill_timeout: 3000
              }]
            };
            EOF
            
            echo "PM2配置文件更新完成"

      - name: Restart PM2 service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.TARGET_DIR }}
            echo "重启PM2服务..."
            
            # 停止现有服务
            pm2 stop blog-backend || echo "服务未运行"
            pm2 delete blog-backend || echo "服务未存在"
            
            # 使用生产环境配置启动服务
            pm2 start ecosystem.config.js --env production --only blog-backend
            
            # 保存PM2配置
            pm2 save
            
            echo "PM2服务重启完成"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.TARGET_DIR }}
            
            # 等待服务启动
            echo "等待服务启动..."
            sleep 10
            
            # 检查环境变量
            echo "=== 检查环境变量 ==="
            node test-env.js
            
            # 检查服务状态
            echo "=== 检查服务状态 ==="
            pm2 status
            
            # 检查端口监听
            echo "=== 检查端口监听 ==="
            netstat -tlnp | grep :3000 || echo "端口3000未监听"
            
            # 检查PM2环境变量
            echo "=== 检查PM2环境变量 ==="
            pm2 env blog-backend
            
            echo "部署验证完成"